/*
 * Copyright 1993 Ola Liljedahl
 */

#include <stdlib.h>
#include "stdio.h"
#include "movetable.h"
#include "normalize.h"

#define MOVEINFOSIZE 5

#define MOVETABLESIZE (1+1+3+14+81)
static const struct {	board brade; uint8_t moves[4]; } movetable[MOVETABLESIZE]=
{
	{ { 0x0000000810000000ULL, 0x0000001008000000ULL },{ 19,26,37,44 } },
	{ { 0x0000000818080000ULL, 0x0000001000000000ULL },{ 18,34,64,64 } },
	{ { 0x0000000810080000ULL, 0x0000001008040000ULL },{ 26,64,64,64 } },
	{ { 0x000000001c000000ULL, 0x0000001c00000000ULL },{ 43,64,64,64 } },
	{ { 0x0000000018080000ULL, 0x0000001c00000000ULL },{ 43,44,45,64 } },
	{ { 0x00000008100e0000ULL, 0x0000001008000000ULL },{ 20,64,64,64 } },
	{ { 0x000000081c080000ULL, 0x0000001000040000ULL },{ 20,64,64,64 } },
	{ { 0x0000001418100000ULL, 0x0000040800000000ULL },{ 26,64,64,64 } },
	{ { 0x0000001438000000ULL, 0x0000040800000000ULL },{ 26,64,64,64 } },
	{ { 0x0000000808182000ULL, 0x0000001010000000ULL },{ 34,64,64,64 } },
	{ { 0x0000000818380000ULL, 0x0000001000000000ULL },{ 34,64,64,64 } },
	{ { 0x0000000838080000ULL, 0x0000001000100000ULL },{ 18,64,64,64 } },
	{ { 0x0000001c18100000ULL, 0x0000000000080000ULL },{ 21,64,64,64 } },
	{ { 0x0000001c10200000ULL, 0x000000000c000000ULL },{ 42,64,64,64 } },
	{ { 0x000000080c102000ULL, 0x0000001010000000ULL },{ 34,64,64,64 } },
	{ { 0x000000081c200000ULL, 0x0000001000100000ULL },{ 34,64,64,64 } },
	{ { 0x000000083c000000ULL, 0x0000001000100000ULL },{ 34,64,64,64 } },
	{ { 0x0000000c38000000ULL, 0x0000101000000000ULL },{ 20,64,64,64 } },
	{ { 0x0000000c18200000ULL, 0x0000101000000000ULL },{ 20,64,64,64 } },
	{ { 0x00000008100a0000ULL, 0x0000001008040200ULL },{ 26,64,64,64 } },
	{ { 0x0000000810040400ULL, 0x000000100e000000ULL },{ 34,64,64,64 } },
	{ { 0x0000000014040400ULL, 0x0000001c08000000ULL },{ 42,64,64,64 } },
	{ { 0x0000000014040400ULL, 0x0000081808000000ULL },{ 44,64,64,64 } },
	{ { 0x0000000008700000ULL, 0x0000003810000000ULL },{ 29,64,64,64 } },
	{ { 0x0000000008700000ULL, 0x0000101810000000ULL },{ 29,64,64,64 } },
	{ { 0x0000000018080000ULL, 0x0000001c04040000ULL },{ 25,43,45,64 } },
	{ { 0x0000000818080000ULL, 0x0000207000000000ULL },{ 44,64,64,64 } },
	{ { 0x0000000818080000ULL, 0x0000203020000000ULL },{ 44,64,64,64 } },
	{ { 0x0000001410100000ULL, 0x0000040808080000ULL },{ 26,64,64,64 } },
	{ { 0x0000000418100000ULL, 0x0000043800000000ULL },{ 44,64,64,64 } },
	{ { 0x0000001408100000ULL, 0x0000040810200000ULL },{ 29,43,64,64 } },
	{ { 0x0000000818080000ULL, 0x0010301000000000ULL },{ 37,64,64,64 } },
	{ { 0x0000000818080000ULL, 0x0000381000000000ULL },{ 52,64,64,64 } },
	{ { 0x0000000c28000000ULL, 0x0000101010200000ULL },{ 37,64,64,64 } },
	{ { 0x0000000438000000ULL, 0x0000043800000000ULL },{ 44,64,64,64 } },
	{ { 0x0000001428000000ULL, 0x0000040810200000ULL },{ 20,64,64,64 } },
	{ { 0x0000000808102000ULL, 0x0000001010080400ULL },{ 29,64,64,64 } },
	{ { 0x0000000808082000ULL, 0x0000001010101000ULL },{ 29,64,64,64 } },
	{ { 0x0000000800182000ULL, 0x0000001018040000ULL },{ 17,34,44,37 } },
	{ { 0x0000000800182000ULL, 0x0000001018040000ULL },{ 21,64,64,64 } },
	{ { 0x0000000800182000ULL, 0x000000101c000000ULL },{ 33,17,34,44 } },
	{ { 0x0000000800182000ULL, 0x000000101c000000ULL },{ 37,21,64,64 } },
	{ { 0x0000000008182000ULL, 0x0000001c10000000ULL },{ 41,43,44,45 } },
	{ { 0x0000000008182000ULL, 0x0000001c10000000ULL },{ 37,29,64,64 } },
	{ { 0x0000000008182000ULL, 0x0000041810000000ULL },{ 43,44,45,37 } },
	{ { 0x0000000008182000ULL, 0x0000041810000000ULL },{ 29,64,64,64 } },
	{ { 0x0000000808280000ULL, 0x0000001010101000ULL },{  3, 5,13,29 } },
	{ { 0x0000000808280000ULL, 0x0000001010101000ULL },{ 37,45,64,64 } },
	{ { 0x0000000810380000ULL, 0x0000001008040000ULL },{ 37,44,34,26 } },
	{ { 0x0000000810380000ULL, 0x0000001008040000ULL },{ 17,64,64,64 } },
	{ { 0x00000000181c0000ULL, 0x0000003800000000ULL },{ 42,43,44,45 } },
	{ { 0x00000000181c0000ULL, 0x0000003800000000ULL },{ 46,64,64,64 } },
	{ { 0x0000000810100000ULL, 0x0000203028000000ULL },{ 19,64,64,64 } },
	{ { 0x0000000818080000ULL, 0x0000001020500000ULL },{ 30,64,64,64 } },
	{ { 0x000000000c100000ULL, 0x0000003810080000ULL },{ 18,64,64,64 } },
	{ { 0x0000000818080000ULL, 0x0000005020100000ULL },{ 30,64,64,64 } },
	{ { 0x0000001818080000ULL, 0x0000202020000000ULL },{ 54,46,38,30 } },
	{ { 0x0000001818080000ULL, 0x0000202020000000ULL },{ 22,64,64,64 } },
	{ { 0x0000001418100000ULL, 0x0000100804000000ULL },{ 52,43,42,25 } },
	{ { 0x0000001418100000ULL, 0x0000100804000000ULL },{ 18,64,64,64 } },
	{ { 0x0000001410100000ULL, 0x0000080808080000ULL },{ 10,18,26,42 } },
	{ { 0x0000001410100000ULL, 0x0000080808080000ULL },{ 52,50,64,64 } },
	{ { 0x0000000818200000ULL, 0x0004181000000000ULL },{ 37,45,53,52 } },
	{ { 0x0000000818200000ULL, 0x0004181000000000ULL },{ 51,64,64,64 } },
	{ { 0x0000000818200000ULL, 0x00001c1000000000ULL },{ 37,45,53,52 } },
	{ { 0x0000000818200000ULL, 0x00001c1000000000ULL },{ 51,49,64,64 } },
	{ { 0x0000001410200000ULL, 0x000008080c000000ULL },{ 52,50,42,25 } },
	{ { 0x0000001410200000ULL, 0x000008080c000000ULL },{ 20,18,64,64 } },
	{ { 0x0000001410200000ULL, 0x000010080c000000ULL },{ 52,42,25,20 } },
	{ { 0x0000001410200000ULL, 0x000010080c000000ULL },{ 18,64,64,64 } },
	{ { 0x0000000c10200000ULL, 0x000020100c000000ULL },{ 25,17,18,19 } },
	{ { 0x0000000c10200000ULL, 0x000020100c000000ULL },{ 44,20,37,64 } },
	{ { 0x0000001c00200000ULL, 0x000000003c000000ULL },{ 17,18,19,20 } },
	{ { 0x0000001c00200000ULL, 0x000000003c000000ULL },{ 37,22,64,64 } },
	{ { 0x0000000800102000ULL, 0x000000101e000000ULL },{ 17,34,19,44 } },
	{ { 0x0000000800102000ULL, 0x000000101e000000ULL },{ 37,21,64,64 } },
	{ { 0x0000000804102000ULL, 0x0000001018040000ULL },{ 34,10,19,44 } },
	{ { 0x0000000804102000ULL, 0x0000001018040000ULL },{ 37,29,21,64 } },
	{ { 0x000000000c102000ULL, 0x0000001c10000000ULL },{ 41,42,43,44 } },
	{ { 0x000000000c102000ULL, 0x0000001c10000000ULL },{ 45,29,64,64 } },
	{ { 0x000000000c102000ULL, 0x0000041810000000ULL },{ 43,44,45,29 } },
	{ { 0x000000080c002000ULL, 0x0000001010101000ULL },{ 11,21,29,37 } },
	{ { 0x000000080c002000ULL, 0x0000001010101000ULL },{ 45,64,64,64 } },
	{ { 0x0000000814200000ULL, 0x0000001008140000ULL },{ 37,44,12,19 } },
	{ { 0x0000000814200000ULL, 0x0000001008140000ULL },{ 10,64,64,64 } },
	{ { 0x0000000014200000ULL, 0x0000001c08100000ULL },{ 42,19,44,12 } },
	{ { 0x0000000818080000ULL, 0x0004041400000000ULL },{ 37,44,64,64 } },
	{ { 0x0000000834000000ULL, 0x0000001008140000ULL },{ 19,64,64,64 } },
	{ { 0x000000002c000000ULL, 0x0000003810080000ULL },{ 44,64,64,64 } },
	{ { 0x0000000818080000ULL, 0x0004081400000000ULL },{ 51,64,64,64 } },
	{ { 0x0000000818080000ULL, 0x0010081400000000ULL },{ 51,64,64,64 } },
	{ { 0x000000001c000000ULL, 0x0000087800000000ULL },{ 42,64,64,64 } },
	{ { 0x0000000438000000ULL, 0x0000101804000000ULL },{ 42,64,64,64 } },
	{ { 0x0000000c30000000ULL, 0x0000101008040000ULL },{ 26,20,64,64 } },
	{ { 0x0000000c28000000ULL, 0x0000101010100000ULL },{ 21,37,64,64 } },
	{ { 0x0000000818100000ULL, 0x0004083000000000ULL },{ 45,64,64,64 } },
	{ { 0x0000000018040000ULL, 0x0000087800000000ULL },{ 45,64,64,64 } },
	{ { 0x0000000418200000ULL, 0x0000101804000000ULL },{ 42,43,64,64 } },
	{ { 0x0000000c10200000ULL, 0x0000101008040000ULL },{ 26,20,64,64 } },
	{ { 0x0000000c08200000ULL, 0x0000101010100000ULL },{ 29,64,64,64 } },
};

STATIC move_t table_move(board brade)
{
	unsigned int movenr=count_matrix(brade.black)+count_matrix(brade.white)-4;
	if(movenr<MOVEINFOSIZE)
	{
#define EQUAL(b1,b2) (b1.black==b2.black && b1.white==b2.white)
#define MAX 20
		move_t possible[MAX];
		int numpossible=0,i;
		int transform=normalize_board(&brade);
		printf("Interesting moves:");
		for(i=0;i<MOVETABLESIZE;i++)
		{
			if(EQUAL(brade,movetable[i].brade))
			{
				int j;
				for(j=0;j<4;j++)
				{
					if(movetable[i].moves[j]<64)
					{
						move_t move=movetable[i].moves[j];
						possible[numpossible++]=move;
						move=inverse_transform_move(move,transform);
						printf(" %c%c",move%8+'a',move/8+'1');
					}
				}
			}
			else if(numpossible) break; /* last was no match but we have found matches previously */
		}
		if(numpossible)
		{
			move_t move=possible[rand()%numpossible];
			move=inverse_transform_move(move,transform);
			printf("\n");
			return move;
		}
		else
		{
			printf(" none\n");
		}
	}
	return none; /* failed */
}
